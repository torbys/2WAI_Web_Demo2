<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>2WAI Demo</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
	<link rel="stylesheet" href="swiper.min.css">
	<link rel="stylesheet" href="index.css">


</head>

<body>

	<audio src="./soundEffect/submit.mp3" style="display: none;" id="submitPlayer"></audio>
	<audio src="./soundEffect/changeStyle.mp3" style="display: none;" id="changeItemVoice"></audio>
	<audio src="./soundEffect/pop.mp3" style="display: none;" id="popVoice"></audio>
	<audio src="./soundEffect/mouse_click1.mp3" style="display: none;" id="optionsVoice"></audio>
	<audio src="./soundEffect/record.mp3" style="display: none;" id="recordVoice"></audio>
	<audio src="./soundEffect/stop_record.mp3" style="display: none;" id="stopVoice"></audio>
	<audio src="./soundEffect/swiperScroll.mp3" style="display: none;" id="ScrollVoice"></audio>

	<div class="outer-container">
	
		<div class="inner-container">

			<!-- z左侧视频面板 -->
			<div class="panel-left ">
				<!-- col-lg-12 -->
				<div class="Error-Dialog">
					<div class="loader"></div>
					<div class="text">Connection in progress...</div>
				</div>

				<div class="Time-out">
					<img class="Tcancel" src="./icon/cancel.png" alt="">
					<div class="Outicon">
						<img src="./icon/linkicon.png" alt="">
					</div>
					<div class="text">Connection Timeout</div>
					<button>Refresh</button>
				</div>

				<div class="control-panel">
					<div class="option">
						<input id="use-stun" type="checkbox" checked />
						<label for="use-stun">Use STUN server</label>
					</div>
				</div>

				<div class="ZoomClick no-select">
					<div class="ZoomGroup">
						<img src="./icon/more.png" id="Zoom-out" alt="">
						<img src="./icon/line.png" id="Zoom-in" alt="">
					</div>
				</div>

				<div class="bottom-icon no-select">
					Zoom
					<div class="moveWrapper">
						<img src="./icon/move.png" alt="" id="zoomIcon" />
					</div>
				</div>

				<div class="demo no-select">
					2WAI
					<div class="tips">
						Demo
					</div>
				</div>

				<div id="FeatureArea">
					<div class="Featureitem" id="change_item">
						<img src="./icon/change.png" alt="" />
					</div>
					<div class="Featureitem" id="clothes_item">
						<img src="./icon/clothes.png" alt="" />
					</div>
				</div>



				<!-- 视频展示区 -->
				<div id="media">
					

					<div class="Hint">


						<svg width="359" height="346" viewBox="0 0 359 346" fill="none" xmlns="http://www.w3.org/2000/svg">
							<path d="M85.5322 169.5C82.5322 165 73.0322 150.5 84.0322 140.5C81.0724 138 67.4919 114.5 62.9919 107.5C58.4919 100.5 34.992 71.5004 20.492 55.0004C5.99197 38.5004 0.491974 27.5004 0.991974 13.0004C1.26462 5.09382 10.9973 0.526636 16.4609 1.00037C21.0171 1.39541 21.0816 5.99951 24.492 8.50045C31.992 14.0004 51.492 38.0004 64.492 49.5004C77.492 61.0004 87.992 71.5005 103.492 83.5005C96.992 77.0005 95.492 67.0004 107.492 62.0004C117.092 58.0004 134.519 63.6671 142.032 67.0005C143.699 64.8338 149.932 59.0004 159.532 59.0004C171.532 59.0004 196.532 70.0005 208.532 76.5005C216.032 77.0005 223.032 77.0005 245.032 80.5005C267.032 84.0005 273.532 95.5005 276.032 106C278.532 116.5 308.032 203 321.532 218.5C350.532 248 357.532 257.5 358.532 275.5C359.532 293.5 341.532 307 330.532 317C312.032 337 303.532 345 286.532 345.5C269.532 346 252.532 329 245.032 319C237.532 309 204.532 283.5 188.032 279C159.532 272 115.532 231 112.532 228.5C109.532 226 107.532 225 104.532 218.5C101.532 212 88.5322 174 85.5322 169.5Z" fill="url(#paint0_radial_1115_845)"/>
							<defs>
							<radialGradient id="paint0_radial_1115_845" cx="0" cy="0" r="1" gradientUnits="userSpaceOnUse" gradientTransform="translate(23.492 17.5004) rotate(48.5069) scale(491.299 513.333)">
							<stop stop-color="white"/>
							<stop offset="0.447917" stop-color="#F8F8F8" stop-opacity="0.7"/>
							<stop offset="1" stop-color="white" stop-opacity="0.3"/>
							</radialGradient>
							</defs>
						</svg>	

						<div class="loader3">
							<div class="box">
							  <div class="logo">
								
							  </div>
							</div>

							<div class="box"></div>
							<div class="box"></div>
						  </div>
  

						<div class="Hint-message">
							Long press for two seconds to activate the zoom
						</div>
						

						<button id="hint-button">I got it</button>
					</div>

					<div id="video-mask">

						<div id="TTS-title" name="TTS-title">TTS Selection</div>
						<div class="btn_wrapper">
							<img src="./icon/bottom.png" alt="" />
						</div>


						<div class="TTS-item">
							<!-- 选择项在此处动态添加 -->
						</div>
					</div>

					
					<!--<audio id="audio" autoplay="true"></audio> 
				<video id="video" preload="auto" poster="./icon/loadingBackGorund.png" autoplay playsinline loop muted>
				  <source src="./video/base.mp4" type="video/mp4"> 
				</video>-->

					<audio id="audio" autoplay="false"></audio>
					<video id="video" autoplay="true" playsinline="true" muted src="./video/base.mp4"></video>

					<div id="activeLineZoom" class="visualizer-container hidden1"></div>


					<!-- 背景更换区 -->
					<div class="bannerWrapper">
						<div class="swiper-container" id='swiper1'>
							<div class="swiper-wrapper">
								<div class="swiper-slide">
									<img src="./icon/0.png" alt="" />
								</div>
								<div class="swiper-slide">
									<img src="./icon/1.png" alt="" />
								</div>
								<div class="swiper-slide">
									<img src="./icon/2.png" alt="" />
								</div>
								<div class="swiper-slide">
									<img src="./icon/3.png" alt="" />
								</div>
								<div class="swiper-slide">
									<img src="./icon/4.png" alt="" />
								</div>
								<div class="swiper-slide">
									<img src="./icon/5.png" alt="" />
								</div>
								<div class="swiper-slide">
									<img src="./icon/6.png" alt="" />
								</div>
							</div>
						</div>
						<div class="swiper-button-prev swiper-button-white btn_1" id="prev1">
							<img src="./icon/preImg.png" alt="">
						</div>
						<div class="swiper-button-next swiper-button-white btn_1" id="next1">
							<img src="./icon/nexImg.png" alt="">
						</div>
					</div>


					<!-- 声音切换区  -->
					<div class="bannerWrapper">
						<div class="swiper-container" id='swiper2'>
							<div class="swiper-wrapper">
							</div>
						</div>
						<div class="swiper-button-prev swiper-button-white btn_2" id="prev2">
							<img src="./icon/preImg.png" alt="">
						</div>
						<div class="swiper-button-next swiper-button-white btn_2" id="next2">
							<img src="./icon/nexImg.png" alt="">
						</div>
					</div>


					<!-- 人物切换区  -->
					<div class="bannerWrapper">
						<div class="swiper-container" id='swiper3'>
							<div class="swiper-wrapper">
							</div>
						</div>
						<div class="swiper-button-prev swiper-button-white btn_3" id="prev3">
							<img src="./icon/preImg.png" alt="">
						</div>
						<div class="swiper-button-next swiper-button-white btn_3" id="next3">
							<img src="./icon/nexImg.png" alt="">
						</div>
					</div>


					<!-- 衣服更换区 -->
					<div class="bannerWrapper">
						<div class="swiper-container" id='swiper4'>
							<div class="swiper-wrapper">
								<div class="swiper-slide">
									<img src="./icon/choice1.jpg" alt="" />
								</div>
								<div class="swiper-slide">
									<img src="./icon/choice1.jpg" alt="" />
								</div>
								<div class="swiper-slide">
									<img src="./icon/choice1.jpg" alt="" />
								</div>
								<div class="swiper-slide">
									<img src="./icon/choice1.jpg" alt="" />
								</div>
								<div class="swiper-slide">
									<img src="./icon/choice1.jpg" alt="" />
								</div>
							</div>
						</div>
						<div class="swiper-button-prev swiper-button-white btn_4" id="prev4">
							<img src="./icon/preImg.png" alt="">
						</div>
						<div class="swiper-button-next swiper-button-white btn_4" id="next4">
							<img src="./icon/nexImg.png" alt="">
						</div>
					</div>

					<!-- 缩放后的聊天面板 -->
				<div class="panel-zoom">

					
					<div class="moblieZoom">
						<div class="ZoomGroup2">
							<img src="./icon/more.png" id="Zoom-out2" alt="">
							<img src="./icon/line.png" id="Zoom-in2" alt="">
						</div>
					</div>

					<!-- 输入区 -->
					<div class="zoom-bottom">

						<!-- <audio src="" style="display: none;" id="zoomVoice"></audio> -->
						
						<button id="speak-button" class="hidden1">Hold on and speak</button>
						
						<textarea class="form-control" id="message2"
							placeholder="Type your message here..."></textarea>

					
						<div id="image-container-zoom"
							style="margin-top: 0;margin-left: 10px;background-color: #fff;border-radius: 50%;width: 40px;height: 40px;">
							<img id="voice-image-zoom" class="voice_img" src="./icon/voice-zoom.png" alt="voice"/>
						</div>

					</div>
					
					<!-- 聊天区 -->
					<div class="zoom-left" id="chat-messages-zoom">
						
					</div>

					<!-- 功能区 -->
					<div class="zoom-right">
						<div class="option-item " data-name="avatar">
							<div class="img_container" id="avatar-name">
								<img src="./icon/Digital Human.png" alt="" />
							</div>
							<label for="avatar-name">Avatar</label>
						</div>

						<div class="option-item" data-name="tts">
							<div class="img_container" id="tts-selection_zoom">
								<img src="./icon/cude.png" alt="" />
							</div>

							<label for="tts-selection">TTS</label>
						</div>

						<div class="option-item" data-name="voice">
							<div class="img_container" id="avatar-voice">
								<img src="./icon/voiceLine.png" alt="" />
							</div>
							<label for="avatar-voice">Voice</label>
						</div>

						<div class="option-item" data-name="background">
							<div class="img_container" id="avatar-background">
								<img src="./icon/background.png" alt="" />
							</div>
							<label for="avatar-background">Background</label>
						</div>
					</div>

				</div>


				</div>

				


			</div>

			<!-- 右侧聊天面板 -->
			<div class="panel ">

				<div class="chat-container" id="chat-messages">
					<div class="welcome-message">
						<!-- <span>Welcome! You can click the <img src="./icon/voice.png" alt="" class="voice_img" /> icon
							below or enter text to talk to me</span> -->
					</div>
					<!-- 聊天消息将在这里动态添加 -->
				</div>

				<form class="form-inline" id="echo-form">

					<div id="image-container">
						<img id="voice-image" class="voice_img" src="./icon/voice.png" alt="voice"
							onclick="changeImage()" />
					</div>

					<div class="gap"></div>

					<textarea class="form-control" id="message" placeholder="Type your message here..."></textarea>

					<div id="recordGroup1" class="hidden">
						<div id="record_wrapper">
							<img id="recording" src="./icon/voice_dark.png" alt="microphone" />
						</div>
						<img id="recordLine" src="./icon/recordLine.png" alt="Line" />
						<div id="recordTime_base">0.00</div>
					</div>

					<div id="recordGroup2" class="hidden">
						<div id="stop_wrapper">
							<div id="stop_record"></div>
						</div>

						<div id="activeLinePC" class="visualizer-container"></div>
					
						<div id="recordTime">0.00</div>
					</div>

					<div class="audio-preview hidden">

						<audio id="audio-player"></audio>
						<div id="custom-player">
							<img src="./icon/play.png" alt="">
						</div>

						<p id="file-name"></p>

						<img id="activeLine2" src="./icon/vioce_active.gif" alt="动画演示">

						<div id="recordTime2">0.00</div>

						<button id="delete-audio">
							<img src="./icon/cancel2.png" alt="">
						</button>
					</div>

					<!-- $('#audio-preview').show(); // 显示音频预览区域
                    $('#audio-player').attr('src', `/tmp/${fileName}`); // 设置音频播放器的源为服务器上的音频文件
                    $('#file-name').text(fileName); // 设置文件名显示为上传的文件名
                    $('#delete-audio').show(); // 显示删除音频的按钮 -->




					<!-- <div>
				    <label for="btn-record"></label>
				    <button class="btn btn-primary" id="btn_start_record">Start Recording</button>
				    <button class="btn btn-primary" id="btn_stop_record" disabled>Stop Recording</button>
				</div> -->

					<!-- 按钮包裹的提交 -->
					<button type="submit" class="btn btn-default">
						<img class="submit" src="./icon/base_submit.png" alt="submit" />
					</button>

					<div class="gap"></div> <!-- 间隔竖线 -->

					<div class="more" id="moreButton">
						<img id="more_img" src="./icon/more.png" alt="" />
					</div>

				</form>

				<!-- 隐藏式选择框 -->
				<div id="options-container">
					<div class="options-group">
						<div class="option-item " data-name="avatar">
							<div class="img_container" id="avatar-name">
								<img src="./icon/Digital Human.png" alt="" />
							</div>
							<label for="avatar-name">Avatar</label>
						</div>

						<div class="option-item" data-name="tts">
							<div class="img_container" id="tts-selection">
								<img src="./icon/cude.png" alt="" />
							</div>

							<label for="tts-selection">TTS</label>
						</div>

						<div class="option-item" data-name="voice">
							<div class="img_container" id="avatar-voice">
								<img src="./icon/voiceLine.png" alt="" />
							</div>
							<label for="avatar-voice">Voice</label>
						</div>

						<div class="option-item" data-name="background">
							<div class="img_container" id="avatar-background">
								<img src="./icon/background.png" alt="" />
							</div>
							<label for="avatar-background">Background</label>
						</div>

					</div>

					<!-- 拖拉调节条 -->
					<div class="option-line">
						<label for="chunk-size">Min Length</label>
						<div class="slider-with-input">
							<div class="slider-container">
								<input type="range" id="chunk-size" class="form-control" min="0" max="30" step="1"
									value="10" style="width: 1000px" ;>
								<div class="number-box-container" style="display: none;">
									<input type="number" id="chunk-size-input" class="form-control" min="0" max="30"
										value="10">
								</div>
							</div>
						</div>
					</div>

				</div>

			</div>
		</div>

	</div>




</body>

<script>

	// const host = 'https://wxqawnt5040hm5-7862.proxy.runpod.net'; 
	//const host = 'http://47.96.160.235:7862'; 
	// const host = 'https://6sme1xw3s55ryw-7862.proxy.runpod.net'; 
	//const host='https://66.114.112.70';
	// const host ='http://47.96.160.235:7862';
	// const host = 'http://52.11.182.61:7862';

	//aws1
	//const host = 'http://35.89.226.131:7862';

	//aws2
	// const host= 'http://35.153.157.142:7862's

	//1.13runpod
	// const host = 'https://g754ua0bibbm8a-7862.proxy.runpod.net'

	//1.15的服务器
	// const host = 'http://18.237.173.80:7862'

	//1.22日服务器
	// const host='http://18.246.161.188:7862'

	//index2的https请求
	// const host='https://waverlyc4.xiaomy.net'

	//1.19日服务器
	// const host='http://52.40.208.108:7862'

	//1.31日服务器
	const host = 'http://18.237.179.127:7862'

	//var avatarName = "avatar1";  	//会话人物

	var avatarName = "avatar5"		//Miami会话默认
	var ttsSelection = "tts1";   	//会话模块
	var avatarVoice = "voice1"; 	//会话声音

	var sessionid = "";				//会话id
	var isConnected = false;		//链接状态
	var noticeFlag=false;			//Hint标志
	var canSubmit = 0; 				// 提交标志，默认为0
	var streamType = "AUDIO_VIDEO"     // 推流方式

	//推流方式
	// LLM_ONLY   
	// AUDIO_ONLY 
	// AUDIO_VIDEO
	// AUDIO_VIDEO

	var dataAvatars = [];			//获取的模型人物名字集合
	var datatVoices = [];			//获取的声音集合

	let mediaRecorder;
	let audioChunks = [];
	let isRecording = false;  // 添加录音状态标志
	let audioStream; // 用于存储麦克风流的全局变量

	// 获取轮播区域元素
	var buttons1 = document.querySelectorAll('.btn_1');
	var swiperBox1 = document.getElementById('swiper1');
	var buttons2 = document.querySelectorAll('.btn_2');
	var swiperBox2 = document.getElementById('swiper2');
	var buttons3 = document.querySelectorAll('.btn_3');
	var swiperBox3 = document.getElementById('swiper3');

	// 检查并显示 Hint 的函数
	function checkAndShowHint() {
		const mediaQuery = window.matchMedia('(max-width: 1000px)');
	    if (mediaQuery.matches && !noticeFlag) {
	        const hint = document.querySelector('.Hint');
	        hint.style.display = 'flex';
			noticeFlag=true;
	    } else {
	        // 否则，隐藏 Hint
	        const hint = document.querySelector('.Hint');
	        hint.style.display = 'none';
	    }
	}

	// 显示 loading 提示的函数
	function showLoading() {
		var loadingElement = document.querySelector('.Error-Dialog');
		loadingElement.classList.add('pop');
		document.body.style.pointerEvents = 'none';
	}

	// 隐藏 loading 提示的函数
	function hideLoading() {
		var loadingElement = document.querySelector('.Error-Dialog');
		loadingElement.classList.remove('pop');
		checkAndShowHint();
		document.body.style.pointerEvents = 'auto';
	}

	function hideSwiperAndButtons(swiperBox, buttons) {
		// 如果轮播区域显示，则隐藏轮播区域和所有按钮
		if (swiperBox.classList.contains('show')) {
			swiperBox.classList.remove('show');
			buttons.forEach(function (button) {
				button.classList.remove('show');
			});
		}
	}
</script>


<!-- <script type="text/javascript" src="http://cdn.sockjs.org/sockjs-0.3.4.js"></script> -->
<script type="text/javascript" src="jquery-2.1.1.min.js"></script>
<script src="swiper.min.js"></script>
<script src="js/audioVisualizer.js"></script>
<script src="client_wn.js"></script>

<script>

	function cancelSelection(id) {
	    var $selectedItem = $('#' + id);
		$('.img_container').removeClass('selected');
		$('.img_container img').removeClass('selected-filter'); // 移除所
	}

	function setHeightToVideo() {
	    var video = document.getElementById('video');
	    if (video) { // 确保视频元素存在
	        var videoHeight = video.clientHeight;
	        var videoWidth = video.clientWidth; // 获取视频宽度
	        console.log("小屏视频高度：" + videoHeight + ", 宽度：" + videoWidth);
		
	        if (window.innerWidth <= 1100) {
	            // 设置html和body的高度和宽度为视频的尺寸
	            document.documentElement.style.height = videoHeight + 'px';
	            document.documentElement.style.width = videoWidth + 'px';
	            document.body.style.height = videoHeight + 'px';
	            document.body.style.width = videoWidth + 'px';
	            document.body.style.overflow = 'hidden'; // 隐藏滚动条
	        }else{
				document.documentElement.style.height = '';
	            document.documentElement.style.width = '';
	            document.body.style.height = '';
	            document.body.style.width ='';
	            document.body.style.overflow = ''; // 隐藏滚动条
			}
	    }
	}
	
	window.addEventListener('resize', setHeightToVideo);
	window.addEventListener('load', setHeightToVideo);


	// 获取视频元素
	const video = document.getElementById('video');
	const chatContainer = document.querySelector('.chat-container');
	const form = document.getElementById('echo-form');
	var chatContainerHeight;

	// 定义一个函数来设置 chat-container 的高度
	function setChatContainerHeightToVideo() {
	    // 获取视频的实际显示高度
	    const videoHeight = video.offsetHeight;

	    // 获取 form 的高度
	    const formHeight = form.offsetHeight;

	    // 计算 chat-container 的高度（视频高度减去 form 高度）
	    chatContainerHeight = videoHeight - formHeight;

	    console.log("视频高度: " + videoHeight);
	    console.log("表单高度: " + formHeight);
	    console.log("聊天容器高度: " + chatContainerHeight);

	    // 设置 chat-container 的高度
	    chatContainer.style.maxHeight = `${chatContainerHeight}px`;
	}

	// 监听页面加载完成事件
	window.addEventListener('DOMContentLoaded', () => {
	    // 确保视频已加载元数据
	    if (video.readyState > 0) {
	        setChatContainerHeightToVideo();
	    } else {
	        video.addEventListener('loadedmetadata', setChatContainerHeightToVideo);
	    }
	});

	/*max滑块的更改*/
	const chunkSize = document.getElementById('chunk-size');
    const chunkSizeInput = document.getElementById('chunk-size-input');
    const numberBoxContainer = document.querySelector('.number-box-container');
    const sliderContainer = document.querySelector('.slider-container');

    // 处理滑块移动事件
    chunkSize.addEventListener('input', function(e) {
    	  const value = e.target.value;
    	  numberBoxContainer.style.display = 'block';
		
    	  // 获取滑块的实际位置
    	  const rect = e.target.getBoundingClientRect();
    	  const thumbWidth = 18; // 滑块的宽度
    	  const containerRect = sliderContainer.getBoundingClientRect();
		
    	  // 计算滑块中心点的位置
    	  const percentage = (value - e.target.min) / (e.target.max - e.target.min);
    	  const thumbLeft = percentage * (rect.width - thumbWidth) + thumbWidth / 2;
		
    	  // 设置数值框的位置，使其对齐滑块中心
    	  numberBoxContainer.style.left = `${thumbLeft}px`;
    	  numberBoxContainer.textContent = value;

    	  if (numberBoxContainer.timeoutId) {
    	    clearTimeout(numberBoxContainer.timeoutId);
    	  }

    	  numberBoxContainer.timeoutId = setTimeout(() => {
    	    numberBoxContainer.style.display = 'none';
    	  }, 500);
    });
    // 同步滑块和输入框的值
    chunkSize.addEventListener('input', function(e) {
    	  chunkSizeInput.value = e.target.value;
    });

    chunkSizeInput.addEventListener('input', function(e) {
    	let value = parseInt(e.target.value);
    	if (value < 0) value = 0;
    	if (value > 30) value = 30;
    	if (!isNaN(value)) {
    	  chunkSize.value = value;
    	}
    });

	/*PC端的滑轮缩放*/
	document.addEventListener('DOMContentLoaded', function () {
		const media = document.getElementById('video');
  		const zoomClick = document.querySelector('.ZoomClick');
  		const moveWrapper = document.querySelector('.moveWrapper');
  		const zoomIcon = document.getElementById('zoomIcon');

  		let resetTimeout = null;

  		// 绑定点击事件，点击 moveWrapper 时将 ZoomClick 的 left 设置为 90%
  		moveWrapper.addEventListener('click', function () {
  		//   zoomClick.style.left = '92%';
  		  zoomClick.style.left = '90%';
  		  clearTimeout(resetTimeout);
		
  		  // 禁用 zoomIcon 的滚轮事件
  		  zoomIcon.removeEventListener('wheel', handleWheel);
		
  		  // 重置定时器
  		  resetTimeout = setTimeout(() => {
  		    zoomClick.style.left = '120%';
  		    // 重新启用 zoomIcon 的滚轮事件
  		    zoomIcon.addEventListener('wheel', handleWheel);
  		  }, 3000);
  		});
	
  		// 绑定操作事件，当用户在 ZoomClick 内部进行操作时重置定时器
  		zoomClick.addEventListener('click', function () {
  		  clearTimeout(resetTimeout);
  		  resetTimeout = setTimeout(() => {
  		    zoomClick.style.left = '120%';
  		    // 重新启用 zoomIcon 的滚轮事件
  		    zoomIcon.addEventListener('wheel', handleWheel);
  		  }, 3000);
  		});
	
  		// 滚轮事件处理函数
  		const handleWheel = (event) => {
  		  	event.preventDefault(); // 阻止默认的滚动行为
			
  		  	const scaleFactor = 1.1; // 缩放因子
  		  	let currentScale = media.style.transform ? parseFloat(media.style.transform.match(/scale\(([^)]+)\)/)[1]) : 1;
			
  		  	// 根据滚轮方向更新缩放比例
  		  	if (event.deltaY < 0) {
  		  	  currentScale *= scaleFactor;
  		  	} else {
  		  	  currentScale /= scaleFactor;
  		  	  // 防止缩放过小导致视频不可见
  		  	  if (currentScale < 0.1) currentScale = 0.1;
  		  	}
		  
  		  	// 应用缩放变换，设置缩放原点为顶部 10% 的位置
  		  	media.style.transformOrigin = 'center 10%'; 
  		  	media.style.transform = `scale(${currentScale})`;
  		};
	
  		// 初始绑定滚轮事件
  		zoomIcon.addEventListener('wheel', handleWheel);
	});

	/*移动端zoom的点击事件*/
	document.addEventListener('DOMContentLoaded', function () {
		const media = document.getElementById('video');
        const zoomOutButton = document.getElementById('Zoom-out2');
        const zoomInButton = document.getElementById('Zoom-in2');
		const zoomGroup = document.querySelector('.ZoomGroup2');

        const scaleLevels = [0.5, 0.75, 1.0, 1.5, 2.0]; // 缩放挡位
        let currentScaleIndex = 2; // 初始索引为2，对应100%
		let tem=(currentScaleIndex / (scaleLevels.length - 1)) * 100;
      
        // 初始化缩放比例
        media.style.transformOrigin = 'center 10%'; 
        media.style.transform = `scale(${scaleLevels[currentScaleIndex]})`;
    
         // 更新 .ZoomGroup 的背景颜色
		 const updateZoomGroupBackground = () => {
  		  const percentage = (currentScaleIndex / (scaleLevels.length - 1)) * 100;
				
  		  // 逐步更新背景颜色
  		  const step = 1; // 每次变化的百分比
  		  const interval = 10; // 每次变化的间隔时间（毫秒）
				
  		  const intervalId = setInterval(() => {
  		    if (tem < percentage) {
  		      tem += step;
  		      if (tem > percentage) tem = percentage;
  		    } else if (tem > percentage) {
  		      tem -= step;
  		      if (tem < percentage) tem = percentage;
  		    }
		
  		    const gradient = `linear-gradient(to bottom, #e1e1e1 ${100 - tem}%, white ${100-tem}%)`;
  		    zoomGroup.style.background = gradient;
		
  		    if (tem === percentage) {
  		      clearInterval(intervalId);
  		    }
  		  }, interval);
  		};

	
  		// 监听 Zoom-out 按钮的点击事件
  		zoomOutButton.addEventListener('click', function (event) {
  		  if (currentScaleIndex < scaleLevels.length - 1) {
  		    currentScaleIndex++;
  		    media.style.transform = `scale(${scaleLevels[currentScaleIndex]})`;
  		    updateZoomGroupBackground();
  		  }
  		});
	
  		// 监听 Zoom-in 按钮的点击事件
  		zoomInButton.addEventListener('click', function (event) {
  		  if (currentScaleIndex > 0) {
  		    currentScaleIndex--;
  		    media.style.transform = `scale(${scaleLevels[currentScaleIndex]})`;
  		    updateZoomGroupBackground();
  		  }
  		});
	
  		// 初始背景更新
  		updateZoomGroupBackground();
	});

	/*PC端zoom的点击事件*/
	document.addEventListener('DOMContentLoaded', function () {
		const media = document.getElementById('video');
        const zoomOutButton = document.getElementById('Zoom-out');
        const zoomInButton = document.getElementById('Zoom-in');
		const zoomGroup = document.querySelector('.ZoomGroup');

        const scaleLevels = [0.5, 0.75, 1.0, 1.5, 2.0]; // 缩放挡位
        let currentScaleIndex = 2; // 初始索引为2，对应100%
		let tem=(currentScaleIndex / (scaleLevels.length - 1)) * 100;
      
        // 初始化缩放比例
        media.style.transformOrigin = 'center 10%'; 
        media.style.transform = `scale(${scaleLevels[currentScaleIndex]})`;
    
         // 更新 .ZoomGroup 的背景颜色
		 const updateZoomGroupBackground = () => {
  		  const percentage = (currentScaleIndex / (scaleLevels.length - 1)) * 100;
				
  		  // 逐步更新背景颜色
  		  const step = 1; // 每次变化的百分比
  		  const interval = 10; // 每次变化的间隔时间（毫秒）
				
  		  const intervalId = setInterval(() => {
  		    if (tem < percentage) {
  		      tem += step;
  		      if (tem > percentage) tem = percentage;
  		    } else if (tem > percentage) {
  		      tem -= step;
  		      if (tem < percentage) tem = percentage;
  		    }
		
  		    const gradient = `linear-gradient(to bottom, #e1e1e1 ${100 - tem}%, white ${100-tem}%)`;
  		    zoomGroup.style.background = gradient;
		
  		    if (tem === percentage) {
  		      clearInterval(intervalId);
  		    }
  		  }, interval);
  		};

	
  		// 监听 Zoom-out 按钮的点击事件
  		zoomOutButton.addEventListener('click', function (event) {
  		  if (currentScaleIndex < scaleLevels.length - 1) {
  		    currentScaleIndex++;
  		    media.style.transform = `scale(${scaleLevels[currentScaleIndex]})`;
  		    updateZoomGroupBackground();
  		  }
  		});
	
  		// 监听 Zoom-in 按钮的点击事件
  		zoomInButton.addEventListener('click', function (event) {
  		  if (currentScaleIndex > 0) {
  		    currentScaleIndex--;
  		    media.style.transform = `scale(${scaleLevels[currentScaleIndex]})`;
  		    updateZoomGroupBackground();
  		  }
  		});
	
  		// 初始背景更新
  		updateZoomGroupBackground();
	});

</script>

<script>
	

	// // 添加视频高度监听和聊天容器高度整功能
	// function adjustChatContainerHeight() {

	// console.log("检查高度")

	// 	const video = document.querySelector('#video');
	// 	const chatContainer = document.querySelector('.chat-container');
	// 	const form = document.querySelector('#echo-form'); // 确保你的表单有一个ID
	// 	const option =document.querySelector("#options-container");
	// 	var adjustedHeight ;

	// 	if (video && chatContainer && form) {

	// 	if (option.classList.contains("open")) {
	// 		const videoHeight = video.offsetHeight;
	// 		const formHeight = form.offsetHeight;
	// 		const optionHeight =  option.offsetHeight
	// 		adjustedHeight = videoHeight - formHeight - optionHeight;
	// 	} else {
	// 		const videoHeight = video.offsetHeight;
	// 		const formHeight = form.offsetHeight;
	// 		adjustedHeight = videoHeight - formHeight;
	// 	}

	// 	if (adjustedHeight > 0) {
	// 		chatContainer.style.height = `${adjustedHeight}px`;
	// 		chatContainer.style.minHeight = `${adjustedHeight}px`;
	// 		chatContainer.style.maxHeight = `${adjustedHeight}px`; // 你可以根据需要调整最大高度
	// 	} else {
	// 		// 如果计算出的高度小于或等于0，你可以设置一个最小高度或者直接使用视频的高度
	// 		chatContainer.style.height = `${videoHeight}px`;
	// 		chatContainer.style.minHeight = `${videoHeight}px`;
	// 		chatContainer.style.maxHeight = `${videoHeight}px`;
	// 	}

	// 	}
	// }

	// // 监听视频加载事件
	// document.querySelector('#video').addEventListener('loadedmetadata', () => {
	// setTimeout(adjustChatContainerHeight, 100); // 迟一点执行以确保视频尺寸已更新
	// });

	// // 创建 ResizeObserver 来监听视频尺寸变化
	// const resizeObserver = new ResizeObserver(entries => {
	// adjustChatContainerHeight();
	// });

	// // 开始观察视频元素
	// resizeObserver.observe(document.querySelector('#video'));

	// // 监听窗口大小变化
	// window.addEventListener('resize', adjustChatContainerHeight);

	// // 定期检查视频高度（以防其他情况导致的变化）
	// setInterval(adjustChatContainerHeight, 100);

</script>

<script src="js/initSwiperTeam.js"></script>
<script src="js/Listeners.js"></script>

<!-- =----------------PC端的发送回复功能--------------------= -->
<script type="text/javascript" charset="utf-8">



	$(document).ready(function () {
		// var host = window.location.hostname
		// var ws = new WebSocket("ws://"+host+":8000/humanecho");
		// //document.getElementsByTagName("video")[0].setAttribute("src", aa["video"]);
		// ws.onopen = function() {
		// console.log('Connected');
		// };
		// ws.onmessage = function(e) {
		// console.log('Received: ' + e.data);
		// data = e
		// var vid = JSON.parse(data.data); 
		// console.log(typeof(vid),vid)
		// //document.getElementsByTagName("video")[0].setAttribute("src", vid["video"]);

		// };
		// ws.onclose = function(e) {
		// console.log('Closed');
		// };

		var submitBtn = $('button[type="submit"]');
		var messageTextarea = $('#message');
		var submitImg = './icon/submit.png'; // 绿色按钮的图片路径
		var baseSubmitImg = './icon/base_submit.png'; // 灰色按钮的图片路径


		// 监听textarea输入事件
		messageTextarea.on('input', function () {
			var message = $(this).val().trim();
			if (message === '') {
				// 如果textarea为空，设置flag为0，显示灰色图片，禁用按钮
				canSubmit = 0;
				submitBtn.prop('disabled', true);
				submitBtn.find('img').attr('src', baseSubmitImg);
			} else {
				// 如果textarea不为空，设置flag为1，显示绿色图片，启用按钮
				canSubmit = 1;
				submitBtn.prop('disabled', false);
				submitBtn.find('img').attr('src', submitImg);
			}
		});

		// 监听textarea回车键事件
		messageTextarea.on('keydown', function (e) {
			if (e.which === 13) { // 检查是否是回车键（键码为13）
				e.preventDefault(); // 阻止默认行为
				if (canSubmit === 1) {
					$('#echo-form').trigger('submit'); // 手动触发表单提交事件
				}
			}
		});

		function addMessage(message, isUser) {
			const messageDiv = $('<div>')
				.addClass('message')
				.addClass(isUser ? 'user-message' : 'bot-message')
				.css({
            		opacity: 0, // 初始透明度为0
            		transform: 'translateY(20px)', // 初始位置在下方20px
            		transition: 'opacity 0.5s, transform 0.5s' // 定义过渡动画
        		});

			// 确定头像路径
			let avatarPath = './icon/icon.png'; // 默认头像路径
			if (!isUser) {
				avatarPath = `./icon/${avatarName}.png`; // 设置为对应的头像路径
			}

			const avatar = $('<img>')
				.addClass('message-avatar')
				.attr('src', avatarPath)
				.attr('alt', isUser ? 'User' : 'Bot');

			const content = $('<div>')
				.addClass('message-content')
				.text(message);

			messageDiv.append(avatar).append(content);
			$('#chat-messages').append(messageDiv);
			$('#chat-messages').scrollTop($('#chat-messages')[0].scrollHeight);

			 // 使用CSS动画实现渐隐滑入效果
			 messageDiv.css({
    		    opacity: 1, // 透明度变为1
    		    transform: 'translateY(0)' // 位置回到初始位置
    		});

			if(!isUser){
				// 按字符分割消息内容
				const characters = message.split(""); // 将字符串分割成单个字符数组
				let currentCharIndex = 0;

				// 逐个字符动态显示消息内容
				const displayNextChar = () => {
				    if (currentCharIndex < characters.length) {
				        // 如果是第一个字符，直接设置内容；否则在现有内容后追加字符
				        if (currentCharIndex === 0) {
				            content.text(characters[currentCharIndex]);
				        } else {
				            content.text(content.text() + characters[currentCharIndex]);
				        }
					
				        currentCharIndex++;
				        // 使用 setTimeout 递归调用，实现逐个字符显示的效果
				        setTimeout(displayNextChar, 40); 
				    }
				};

				// 开始逐个字符显示消息内容
				displayNextChar();
			}

		}

		$('#echo-form').on('submit', function (e) {
			e.preventDefault();
			if (canSubmit === 1) {

				$('#submitPlayer')[0].play();
				// 获取 audio-preview 元素
				var audioPreview = $('.audio-preview');

				

				// 检查 audio-preview 是否没有 hidden 类
				if (!audioPreview.hasClass('hidden')) {
					// 如果没有 hidden 类，则添加 hidden 类
					audioPreview.addClass('hidden');
					messageTextarea.removeClass('hidden');
					// 获取 voice-image 元素
					var image = document.getElementById('voice-image');

					// 设置 voiceFlag 为 true，以便将图标更换为 voice.png
					voiceFlag = true;

					// 设置图片新源为 voice.png
					var newSrc = './icon/voice.png';

					// 添加过渡效果
					image.classList.add('changing');

					// 移除过渡效果类，这将在 CSS 中触发过渡
					setTimeout(function () {
						// 设置图片新源
						image.src = newSrc;
						image.classList.remove('changing');
					}, 300); // 300毫秒后移除，与 CSS 中的过渡时间相匹配
				}

				var message = $('#message').val();
				// 添加用户消息到聊天框
				addMessage(message, true);

				console.log('Sending: ' + message);
				console.log('sessionid: ', sessionid);

				const audio = document.getElementById('audio');
        		audio.play().catch(error => {
        		    console.error('无法自动播放音频:', error);
        		});


				/*网络获取机械人回复*/
				fetch(host + '/human', {
					body: JSON.stringify({
						text: message,
						type: 'chat',
						interrupt: true,
						sessionid: sessionid,
						avatarName: avatarName,
						ttsSelection: ttsSelection,
						avatarVoice: avatarVoice,
						chunkSize: "10"
					}),
					headers: {
						'Content-Type': 'application/json'
					},
					method: 'POST'
				})
				.then(response => response.json())
				.then(data => {
					// 添加机器人的回复消息
					const llmResponse = data.res || "No valid response was returned！";
					addMessage(llmResponse, false);
				})
				.catch(error => {
					console.error('Error:', error);
					// 可选：显示错误消息
					addMessage("Sorry, an error occurred. Please try again later.", false);
				});

				

				// 清空入框并将焦点重新放在输入框上
				$('#message').val('');
				canSubmit = 0;
				submitBtn.find('img').attr('src', baseSubmitImg);
			}
		});

	});
</script>


<script src="js/Options.js"></script>
<script src="js/darkMod.js"></script>
<script src="js/RecordPC.js"></script>
<script src="js/ProgressBarLoading.js"></script>
<script src="js/ZoomAreaUI.js"></script>
<script src="js/MobileRecording.js"></script>
<script src="js/LongPresstoZoom.js"></script>

</html>